# 更新日志

## [2.0.0] - 2025-12-08

### 🎉 新增功能

#### 1. 区间抽奖模式
- 新增"区间开奖"和"区间抽奖"关键词
- 基于时间区间内的发言用户参与抽奖
- 自动排除根消息、触发消息和回复消息
- 显示时间范围和消息数量统计

#### 2. 多次抽奖支持
- 同一根消息支持多次抽奖
- 自动查询历史中奖记录
- 抽奖时自动排除历史中奖用户
- 数据库表移除 UNIQUE 约束

#### 3. 权限校验
- 只有根消息发布人才能触发抽奖
- 非发布人触发时显示友好提示消息
- 通过飞书API获取消息发布人信息

#### 4. @机器人检测
- 必须@机器人才能触发抽奖
- 检查消息的 mentions 数组
- 避免误触发抽奖

#### 5. 增强的中奖消息
- 显示参与人数
- 点赞模式显示点赞数量
- 区间模式显示消息数量和时间范围
- 支持中英文双语显示

### 🔧 优化改进

#### 1. 网络请求重试机制
- 所有飞书API调用自动重试
- 默认最多重试3次
- 指数退避策略（1秒、2秒、3秒）

#### 2. 消息内容清理
- 自动去除@mentions部分
- 支持精确关键词匹配
- 保留原始文本用于日志

#### 3. 时间格式化
- 区间抽奖显示易读的时间格式
- 格式：YYYY-MM-DD HH:mm
- 使用原生JavaScript实现

#### 4. 数据库优化
- 新增 `tenant_key` 字段支持多租户
- 新增 `getDrawsByRootMessageId()` 方法
- 优化索引提升查询性能

### 🐛 Bug修复
- 修复重复开奖的问题（通过历史记录查询）
- 修复网络不稳定导致的抽奖失败
- 修复消息解析错误

### 📝 文档更新
- 更新 README.md 说明新功能
- 新增 MIGRATION.md 迁移文档
- 更新数据库 schema 文档

## [1.0.0] - 2025-11-XX

### 初始版本
- 基础点赞抽奖功能
- Vercel Serverless 部署
- Neon Postgres 存储
- 函数式编程范式
