# 功能测试清单

## 测试前准备
- [ ] 已部署到 Vercel
- [ ] 环境变量已配置（FEISHU_APP_ID, FEISHU_APP_SECRET, DATABASE_URL）
- [ ] 飞书机器人已配置事件回调 URL
- [ ] 数据库表已自动创建

## 基础功能测试

### 1. @机器人检测
- [ ] 发送消息不@机器人 → 不触发抽奖
- [ ] 发送消息@机器人 → 可以触发（需要其他条件）
- [ ] 发送"开奖"但不@机器人 → 不触发

### 2. 权限校验
- [ ] 消息发布人在回复中@机器人 + 发送"开奖" → 成功触发
- [ ] 其他用户在回复中@机器人 + 发送"开奖" → 显示权限提示
- [ ] 提示消息内容：只有消息发布人才能触发抽奖

### 3. 点赞模式抽奖
- [ ] 发布一条测试消息（作为根消息）
- [ ] 至少3个用户点赞该消息
- [ ] 发布人回复@机器人 + "开奖" → 成功抽奖
- [ ] 中奖消息包含：中奖用户、参与人数、点赞数量
- [ ] 检查数据库：lottery_draws 表有新记录

### 4. 区间模式抽奖
- [ ] 发布一条测试消息（作为根消息）
- [ ] 至少3个用户在群内发言（不是回复）
- [ ] 发布人回复@机器人 + "区间开奖" → 成功抽奖
- [ ] 中奖消息包含：中奖用户、参与人数、消息数量、时间范围
- [ ] 检查数据库：lottery_draws 表有新记录

### 5. 区间模式规则验证
- [ ] 根消息不参与抽奖
- [ ] 触发消息不参与抽奖
- [ ] 回复消息不参与抽奖
- [ ] 只有群内主消息的发言用户参与

### 6. 多次抽奖测试
**第一次抽奖**
- [ ] 准备5个用户点赞或发言
- [ ] 执行第一次抽奖 → 成功，假设用户A中奖
- [ ] 检查数据库：1条记录，winner_id = 用户A

**第二次抽奖**
- [ ] 在同一根消息下再次触发抽奖
- [ ] 执行第二次抽奖 → 成功，不应该是用户A
- [ ] 检查数据库：2条记录，同一个 root_message_id

**第三次抽奖**
- [ ] 继续抽奖直到所有用户都中奖
- [ ] 最后一次抽奖后再触发 → 提示"所有参与用户都已中过奖"

### 7. 网络重试测试
- [ ] 在弱网环境下测试
- [ ] 日志显示重试信息
- [ ] 最终成功完成抽奖

### 8. 边界情况测试
- [ ] 没有人点赞（点赞模式）→ 提示"没有参与抽奖的用户"
- [ ] 时间区间内没有人发言（区间模式）→ 提示"没有参与抽奖的用户"
- [ ] 只有1个人参与 → 该用户必中奖
- [ ] 根消息没有 root_id → 提示"没有根消息ID"

## 关键词测试

### 点赞模式关键词
- [ ] @机器人 开奖 → 触发点赞模式
- [ ] @机器人 抽奖 → 触发点赞模式
- [ ] @机器人开奖（无空格）→ 触发点赞模式
- [ ] @机器人 开奖啦 → 不触发（非精确匹配）
- [ ] 开奖@机器人 → 触发（顺序无关）

### 区间模式关键词
- [ ] @机器人 区间开奖 → 触发区间模式
- [ ] @机器人 区间抽奖 → 触发区间模式
- [ ] @机器人 区间开奖啦 → 不触发（非精确匹配）

## 数据库测试

### 数据完整性
- [ ] root_message_id 正确
- [ ] winner_id 正确
- [ ] participant_count 正确
- [ ] chat_id 正确
- [ ] sender_id 正确
- [ ] lottery_message_id 正确
- [ ] tenant_key 正确（如果有）
- [ ] created_at 有值

### 查询功能
- [ ] 使用 `getDrawsByRootMessageId()` 查询历史记录 → 返回正确
- [ ] 使用 `getAllDraws()` 查询所有记录 → 返回正确
- [ ] 使用 `getDrawsByChatId()` 查询群聊记录 → 返回正确
- [ ] 使用 `getStatistics()` 查询统计数据 → 返回正确

## 消息卡片测试

### 中奖消息
- [ ] 显示中奖用户（带@）
- [ ] 显示参与人数
- [ ] 点赞模式显示点赞数量
- [ ] 区间模式显示消息数量
- [ ] 区间模式显示时间范围
- [ ] 显示提示文字："请联系消息发布人，及时领取您的奖品～"

### 权限提示消息
- [ ] 灰色小字
- [ ] 内容："只有消息发布人才能触发抽奖"

## 日志测试

### 关键日志
- [ ] 显示请求ID
- [ ] 显示"检测到抽奖触发关键词"
- [ ] 显示抽奖类型（like/range）
- [ ] 显示权限校验结果
- [ ] 显示历史中奖记录
- [ ] 显示参与用户列表
- [ ] 显示中奖用户
- [ ] 显示执行时间

## 性能测试

### 响应时间
- [ ] 点赞模式（10个点赞）→ < 3秒
- [ ] 点赞模式（100个点赞）→ < 10秒
- [ ] 区间模式（50条消息）→ < 5秒
- [ ] 区间模式（200条消息）→ < 15秒

### 并发测试
- [ ] 同时多个群触发抽奖 → 都能正常工作
- [ ] 不会相互影响

## 降级测试

### 数据库不可用
- [ ] 移除 DATABASE_URL 环境变量
- [ ] 重新部署
- [ ] 执行抽奖 → 成功（使用内存存储）
- [ ] 日志显示"使用内存存储"
- [ ] 历史中奖记录功能降级（仅当前会话）

## 文档验证

- [ ] README.md 描述准确
- [ ] MIGRATION.md 完整记录所有更改
- [ ] CHANGELOG.md 版本信息正确
- [ ] 代码注释清晰

## 部署验证

- [ ] Vercel 部署成功
- [ ] 环境变量正确配置
- [ ] 健康检查 `/api/ping` 返回 200
- [ ] 静态页面 `/` 正常访问
- [ ] API 文档 `/api` 正常访问

---

## 测试结果

**测试日期**: ___________

**测试人**: ___________

**通过数量**: ___ / 总计

**问题记录**:

1. 
2. 
3. 

**总结**: ___________
