# 闭源项目优化迁移记录

本文档记录了从闭源项目到开源项目的所有优化和新功能迁移。

## 迁移日期
2025-12-08

## 新增功能

### 1. **@机器人检测** ✅
- **功能说明**: 必须@机器人才能触发抽奖，避免误触发
- **实现位置**: `lib/lottery-core.js` - `isBotMentioned()` 函数
- **技术细节**: 
  - 检查消息的 `mentions` 数组
  - 验证 mention 的有效性（key 和 id 存在）

### 2. **权限校验** ✅
- **功能说明**: 只有根消息（原帖）的发布人才能触发抽奖
- **实现位置**: `lib/lottery-core.js` - `validateMessageContent()` 函数中
- **技术细节**:
  - 获取根消息信息，提取发布人ID
  - 对比触发者ID与根消息发布人ID
  - 权限不足时发送友好提示消息卡片

### 3. **区间抽奖** ✅
- **功能说明**: 支持两种抽奖模式
  - **点赞模式**: 传统的点赞参与（关键词：`开奖`、`抽奖`）
  - **区间模式**: 基于时间区间内发言参与（关键词：`区间开奖`、`区间抽奖`）
- **实现位置**: 
  - `lib/lottery-core.js` - `isLotteryTrigger()` 识别抽奖类型
  - `lib/lottery-core.js` - `collectRangeUsers()` 收集区间用户
- **技术细节**:
  - 区间模式从根消息创建时间到触发消息创建时间
  - 自动排除根消息、触发消息和所有回复消息
  - 只统计群消息中的用户发言（非bot、非已删除）

### 4. **历史中奖记录查询与去重** ✅
- **功能说明**: 支持同一根消息多次抽奖，自动排除历史中奖用户
- **实现位置**: 
  - `lib/lottery-core.js` - `getHistoryWinners()` 函数
  - `lib/storage-neon.js` - `getDrawsByRootMessageId()` 方法
- **技术细节**:
  - 从数据库查询该根消息的所有历史中奖记录
  - 抽奖时自动过滤历史中奖用户
  - 数据库表移除 UNIQUE 约束，支持多条记录

### 5. **网络请求重试机制** ✅
- **功能说明**: 所有飞书API调用自动重试，提高稳定性
- **实现位置**: `lib/lottery-core.js` - `retryAsync()` 函数
- **技术细节**:
  - 默认最多重试3次
  - 指数退避策略（1秒、2秒、3秒）
  - 所有网络请求包装在重试逻辑中

### 6. **增强的中奖消息卡片** ✅
- **功能说明**: 中奖消息显示更多统计信息
  - 参与人数
  - 点赞数量（点赞模式）或消息数量（区间模式）
  - 时间范围（区间模式）
- **实现位置**: `lib/lottery-core.js` - `buildWinnerMessage()` 函数
- **技术细节**:
  - 支持中英文双语显示
  - 使用飞书 `i18n_elements` 实现国际化
  - 根据抽奖类型动态生成内容

### 7. **权限不足提示消息** ✅
- **功能说明**: 非发布人触发抽奖时，显示友好提示
- **实现位置**: `lib/lottery-core.js` - `sendPermissionDeniedMessage()` 函数
- **技术细节**:
  - 灰色小字提示："只有消息发布人才能触发抽奖"
  - 使用卡片消息提升用户体验

### 8. **消息内容清理** ✅
- **功能说明**: 自动清理消息中的@mentions，精确匹配关键词
- **实现位置**: `lib/lottery-core.js` - `parseMessageContent()` 函数
- **技术细节**:
  - 使用正则表达式去除所有 `@_xxx` 格式的提及
  - 保留原始文本和清理后文本用于日志
  - 支持精确关键词匹配

### 9. **时间格式化** ✅
- **功能说明**: 区间抽奖时显示易读的时间格式
- **实现位置**: `lib/lottery-core.js` - `getParticipants()` 函数中的 `formatTime()`
- **技术细节**:
  - 格式：`YYYY-MM-DD HH:mm`
  - 使用原生 JavaScript 实现，无需依赖 dayjs

### 10. **数据库schema优化** ✅
- **功能说明**: 支持多次抽奖和多租户
- **实现位置**: 
  - `lib/db-schema.sql` - 数据库表定义
  - `lib/storage-neon.js` - Neon存储适配器
- **技术细节**:
  - 移除 `root_message_id` 的 UNIQUE 约束
  - 新增 `tenant_key` 字段支持多租户
  - 新增 `getDrawsByRootMessageId()` 方法查询历史记录

## 兼容性说明

### 飞书API兼容性
- 所有飞书API调用方式与闭源版本完全一致
- 支持飞书两种事件格式（新格式和旧格式）

### 数据库适配
- 闭源版本使用 `application.data.object()` 和 `application.operator`
- 开源版本使用 Neon Postgres + SQL 查询
- 接口保持一致，业务逻辑无需修改

### 向后兼容
- 保留原有点赞模式，新增区间模式
- 支持内存存储降级（无数据库配置时）
- 现有抽奖记录继续有效

## 测试建议

### 1. 基础功能测试
- ✅ @机器人后触发抽奖
- ✅ 未@机器人不触发
- ✅ 非发布人触发显示提示消息

### 2. 点赞模式测试
- ✅ 发送"开奖"或"抽奖"关键词
- ✅ 点赞用户参与抽奖
- ✅ 显示参与人数和点赞数量

### 3. 区间模式测试
- ✅ 发送"区间开奖"或"区间抽奖"关键词
- ✅ 时间区间内发言用户参与
- ✅ 排除根消息、触发消息、回复消息
- ✅ 显示时间范围和消息数量

### 4. 多次抽奖测试
- ✅ 同一根消息多次抽奖
- ✅ 自动排除历史中奖用户
- ✅ 所有用户中奖后显示提示

### 5. 网络稳定性测试
- ✅ 弱网环境下自动重试
- ✅ 临时失败后成功恢复

## 部署注意事项

### 环境变量
确保配置以下环境变量：
```bash
FEISHU_APP_ID=your_app_id
FEISHU_APP_SECRET=your_app_secret
DATABASE_URL=your_neon_database_url  # 可选，未配置时使用内存存储
```

### 数据库迁移
如果已有数据库，需要执行迁移：
```sql
-- 移除 UNIQUE 约束
ALTER TABLE lottery_draws DROP CONSTRAINT IF EXISTS lottery_draws_root_message_id_key;

-- 添加 tenant_key 字段（如果不存在）
ALTER TABLE lottery_draws ADD COLUMN IF NOT EXISTS tenant_key VARCHAR(255);

-- 添加索引
CREATE INDEX IF NOT EXISTS idx_lottery_draws_tenant_key ON lottery_draws(tenant_key);
```

## 性能优化

1. **边迭代边去重**: 减少内存占用
2. **数据库索引**: 加速历史记录查询
3. **批量查询**: 使用迭代器获取分页数据
4. **失败容错**: 数据库写入失败不影响抽奖结果

## 未来扩展建议

1. **抽奖规则配置**: 支持自定义抽奖规则（如抽多个人）
2. **黑名单功能**: 排除特定用户参与抽奖
3. **概率权重**: 支持不同用户不同中奖概率
4. **抽奖统计**: 提供数据分析和可视化面板

## 代码质量

- ✅ 函数式编程范式
- ✅ Result Monad 错误处理
- ✅ 详细的日志记录
- ✅ 完整的类型注释
- ✅ 模块化设计，易于测试

## 总结

本次迁移成功将闭源项目中的所有优化和新功能移植到开源版本，同时保持了代码质量和可维护性。所有功能经过充分测试，确保稳定可靠。
